# 时间轴多视图方案

> **文档创建日期**: 2024-12-22
> **实施完成日期**: 2024-12-22
> **参与模型**: Claude (主控) + Codex + Gemini
> **状态**: ✅ 已实施

---

## 一、需求背景

### 1.1 用户反馈

当前时间轴功能存在以下问题：
- 视觉上"太丑"
- 使用上"不便利"

### 1.2 现有实现分析

| 文件 | 路径 | 行数 | 功能 |
|-----|------|------|------|
| TimelineScreen | `app/src/screens/TimelineScreen.tsx` | 1-114 | 主屏幕，FlatList 容器 |
| WeekCard | `app/src/components/Timeline/WeekCard.tsx` | 1-328 | 可展开周卡片 |
| TrimesterHeader | `app/src/components/Timeline/TrimesterHeader.tsx` | 1-53 | 孕期分隔头 |
| weeklyData | `app/src/data/weeklyData.ts` | 40周数据 | 静态数据源 |

---

## 二、问题诊断（Codex + Gemini 共识）

| 问题维度 | Codex 分析 | Gemini 分析 | 综合诊断 |
|---------|-----------|-------------|---------|
| **信息架构** | 40项垂直列表感觉无尽，难以感知整体进度 | "数据库行"美学，像调试工具/电子表格 | 缺乏旅程感，过于信息化 |
| **视觉层级** | 展开卡片时内容移位，容易丢失位置 | 周数被埋在卡片内，节点太小(18x18) | 层级混乱，当前周不够突出 |
| **进度反馈** | 时间轴装饰性强但无法一眼区分完成/未完成 | 时间线在Header处断裂，破坏流动感 | 进度感知弱 |
| **视觉疲劳** | 高信息密度，交互提示不一致 | 每周都是带边框的盒子，40个堆叠=累人的"阶梯"效果 | "方盒堆砌" |

---

## 三、解决方案：「时间三态」多视图系统

### 3.1 核心理念

提供三种互补的视图模式，覆盖"深度聚焦 → 上下文浏览 → 鸟瞰导航"完整光谱，让用户根据场景自由切换。

### 3.2 视图模式矩阵

| 视图名称 | 用户命名 | 核心用途 | 信息密度 | 默认 |
|---------|---------|---------|---------|------|
| **Focus View** | 📇 本周 | 每日查看，"我这周要知道什么" | 低-中 | ✅ |
| **Journey View** | 📜 旅程 | 上下文感知，"刚过去和即将到来的是什么" | 中-高 | |
| **Grid View** | 📅 全览 | 快速跳转，"跳到第32周" | 低 | |

---

## 四、视图详细设计

### 4.1 「本周」模式 (Focus View) — 默认视图

```
┌─────────────────────────────────────────────────────────────┐
│  [ 📇 本周 ]  [ 📜 旅程 ]  [ 📅 全览 ]                        │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│    ┌─────────────────────────────────────────────────┐      │
│    │               孕 中 期                          │      │
│    │  ┌─────────────────────────────────────────┐   │      │
│    │  │           第 12 周                      │   │      │
│    │  │                                         │   │      │
│    │  │            🍋                           │   │      │
│    │  │         柠檬大小                        │   │      │
│    │  │                                         │   │      │
│    │  ├─────────────────────────────────────────┤   │      │
│    │  │  关键发育                               │   │      │
│    │  │  流产风险大幅下降，神经系统高速发育...   │   │      │
│    │  │                                         │   │      │
│    │  │  ──────────────────────────────────     │   │      │
│    │  │                                         │   │      │
│    │  │  🎯 爸爸任务                            │   │      │
│    │  │  □ 陪同做NT检查                         │   │      │
│    │  │  □ 商量官宣方式                         │   │      │
│    │  └─────────────────────────────────────────┘   │      │
│    └─────────────────────────────────────────────────┘      │
│                                                             │
│              ← ○ ● ○ ○ ○ ○ ... →  (周指示点)                │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

**技术要点**：
- 水平分页滑动 (`FlatList` horizontal + pagingEnabled)
- 每屏一周，大卡片沉浸式
- 孕期颜色作为卡片Header背景
- 底部点指示器显示位置
- 卡片内可垂直滚动查看详情

**优势**：
- 单手操作友好
- 强烈的进度感
- 信息聚焦，减少干扰
- 适合忙碌爸爸日常快速查看

---

### 4.2 「旅程」模式 (Journey View)

```
┌─────────────────────────────────────────────────────────────┐
│  [ 📇 本周 ]  [ 📜 旅程 ]  [ 📅 全览 ]                        │
├─────────────────────────────────────────────────────────────┤
│  ┌─ 进度: 第12周 · 30% ────────────────────○────────────┐   │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│        │  ✓ 第11周 · 无花果                                 │
│    ○───┤                                                    │
│        │                                                    │
│        │                                                    │
│  ╔═════╪════════════════════════════════════════════════╗   │
│  ║     │                                                ║   │
│  ║ ●───┤  第 12 周                                      ║   │
│  ║     │  🍋 柠檬大小                                   ║   │
│  ║     │  ────────────────────────────────────────      ║   │
│  ║     │  关键发育: 流产风险大幅下降...                 ║   │
│  ║     │                                                ║   │
│  ║     │  🎯 爸爸任务: 陪同NT检查                       ║   │
│  ╚═════╪════════════════════════════════════════════════╝   │
│        │                                                    │
│    ○───┤  第13周 · 桃子                                     │
│        │                                                    │
│    ○───┤  第14周 · 柠檬                                     │
│        │                                                    │
└─────────────────────────────────────────────────────────────┘
```

**技术要点**：
- 垂直滚动 (`FlatList` vertical)
- 连续时间线（"脐带"隐喻）
- 当前周自动展开（Hero状态）
- 过去周收起 + 淡化 + ✓
- 未来周收起 + 正常透明度
- 顶部吸顶进度条
- 点击可展开任意周

**视觉改进**（相比现有实现）：
| 元素 | 当前 | 改进 |
|-----|------|------|
| 时间轴线 | 2px灰线，装饰性 | 3-4px圆角线，按孕期着色渐变 |
| 节点 | 18x18固定 | 当前周24px+脉冲动画，过去/未来16px |
| 周数字 | 在卡片内部 | 拉出作为主锚点，28-32px大字 |
| 卡片边框 | 所有卡片1px边框 | 仅当前周有阴影+彩色左边条，其他无边框 |
| 过去周 | opacity 0.75 | opacity 0.6 + ✓图标 + 极简化 |

---

### 4.3 「全览」模式 (Grid View)

```
┌─────────────────────────────────────────────────────────────┐
│  [ 📇 本周 ]  [ 📜 旅程 ]  [ 📅 全览 ]                        │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│   ┌─────────────────────────────────────────────────────┐   │
│   │                 孕 早 期 (1-12周)                   │   │
│   │  ┌────┐ ┌────┐ ┌────┐ ┌────┐ ┌────┐                │   │
│   │  │ 1  │ │ 2  │ │ 3  │ │ 4  │ │ 5  │                │   │
│   │  │ ✓  │ │ ✓  │ │ ✓  │ │ ✓  │ │ ✓  │                │   │
│   │  └────┘ └────┘ └────┘ └────┘ └────┘                │   │
│   │  ┌────┐ ┌────┐ ┌────┐ ┌────┐ ┌────┐                │   │
│   │  │ 6  │ │ 7  │ │ 8  │ │ 9  │ │ 10 │                │   │
│   │  │ ✓  │ │ ✓  │ │ ✓  │ │ ✓  │ │ ✓  │                │   │
│   │  └────┘ └────┘ └────┘ └────┘ └────┘                │   │
│   │  ┌────┐ ╔════╗                                      │   │
│   │  │ 11 │ ║ 12 ║ ← 当前周 (脉冲边框+高亮背景)         │   │
│   │  │ ✓  │ ║ ●  ║                                      │   │
│   │  └────┘ ╚════╝                                      │   │
│   └─────────────────────────────────────────────────────┘   │
│                                                             │
│   ┌─────────────────────────────────────────────────────┐   │
│   │                 孕 中 期 (13-27周)                  │   │
│   │  ┌────┐ ┌────┐ ┌────┐ ┌────┐ ┌────┐                │   │
│   │  │ 13 │ │ 14 │ │ 15 │ │ 16 │ │ 17 │   (灰色/未来)  │   │
│   │  └────┘ └────┘ └────┘ └────┘ └────┘                │   │
│   │  ...                                                │   │
│   └─────────────────────────────────────────────────────┘   │
│                                                             │
│   ┌─────────────────────────────────────────────────────┐   │
│   │                 孕 晚 期 (28-40周)                  │   │
│   │  ...                                                │   │
│   └─────────────────────────────────────────────────────┘   │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

**技术要点**：
- 响应式列数（宽屏5列，窄屏4列）
- 按孕期分组 (3个Section)
- 颜色编码：
  - 过去 = 填充孕期色
  - 当前 = 脉冲边框 + 高亮背景
  - 未来 = 灰框/幽灵态
- 点击任意周 → 自动切换到「本周」模式并显示该周
- 一屏可见40周，快速跳转

---

## 五、视图切换器设计

### 5.1 视觉设计

```
┌─────────────────────────────────────────────┐
│  ┌─────────────────────────────────────┐    │
│  │ ┌──────┐ ┌──────┐ ┌──────┐         │    │  ← 药丸形容器
│  │ │📇本周│ │📜旅程│ │📅全览│         │    │
│  │ └────●─┘ └──────┘ └──────┘         │    │  ← 活动指示器滑动
│  └─────────────────────────────────────┘    │
└─────────────────────────────────────────────┘
```

### 5.2 设计规格

| 属性 | 决策 |
|-----|------|
| **位置** | 顶部粘性，安全区域下方 |
| **样式** | 药丸形分段控制器，`colors.surfaceVariant` 背景 |
| **活动态** | 白色阴影卡片滑动，文字变为 `colors.primary` |
| **图标** | Ionicons: `albums-outline` / `list-outline` / `grid-outline` |
| **动画** | 弹簧动画 (spring) 切换活动指示器 |
| **触觉** | `Haptics.impactAsync(ImpactFeedbackStyle.Light)` |
| **触控目标** | 40px 高度（符合无障碍标准） |
| **无障碍** | `accessibilityRole="tablist"` |

---

## 六、状态与交互逻辑

### 6.1 共享状态设计（已实现）

```typescript
// app/src/state/timelineStore.ts
export type TimelineViewMode = 'focus' | 'journey' | 'grid';

interface TimelineState {
  viewMode: TimelineViewMode;
  focusedWeek: number;
  expandedWeek: number | null;
  lastViewedWeekByView: Partial<Record<TimelineViewMode, number>>;

  setViewMode: (mode: TimelineViewMode, targetWeek?: number) => void;
  setFocusedWeek: (week: number) => void;
  setExpandedWeek: (week: number | null) => void;
  rememberViewAnchor: (mode: TimelineViewMode, week: number) => void;
}
```

### 6.2 锚点保持原则

| 场景 | 行为 |
|-----|------|
| 在「旅程」滚动到第20周 → 切换到「本周」 | 自动显示第20周卡片 |
| 在「全览」点击第30周格子 | 切换到「本周」模式 + 显示第30周 |
| 在「本周」滑到第25周 → 切换到「旅程」 | 滚动到第25周位置 |

### 6.3 切换动画

| 切换类型 | 动画 |
|---------|------|
| 任意 ↔ 任意 | LayoutAnimation.easeInEaseOut |
| 全览点击格子 → 本周 | 直接跳转 + 触觉反馈 |

---

## 七、颜色策略

### 7.1 孕期色彩系统

| 孕期 | 主色 | 用途 |
|-----|------|------|
| 孕早期 (1-12周) | `#84A98C` 灰绿 | 当前周高亮、节点、左边条、网格填充 |
| 孕中期 (13-27周) | `#475569` 岩蓝 | 当前周高亮、节点、左边条、网格填充 |
| 孕晚期 (28-40周) | `#E07A5F` 赤陶 | 当前周高亮、节点、左边条、网格填充 |

### 7.2 状态色彩

| 状态 | Focus View | Journey View | Grid View |
|-----|------------|--------------|-----------|
| **过去** | 可滑动访问 | 淡化+✓+收起 | 填充孕期色 |
| **当前** | 居中显示 | 展开+阴影+脉冲 | 脉冲边框+高亮 |
| **未来** | 可滑动访问 | 正常+收起 | 灰框 |

---

## 八、微交互设计

| 交互点 | 效果 | 实现状态 |
|-------|------|---------|
| **进入屏幕** | 平滑滚动到当前周 | ✅ |
| **视图切换** | 弹簧动画移动活动指示器 + 触觉反馈 | ✅ |
| **Focus 滑动** | 触觉反馈 (selectionAsync) | ✅ |
| **Grid 点击** | 触觉反馈 (impactAsync) + 跳转 Focus | ✅ |
| **展开卡片** | LayoutAnimation + 自动折叠其他 | ✅ |
| **横屏适配** | 动态计算卡片宽度 | ✅ |

---

## 九、组件架构（已实现）

```
app/src/
├── screens/
│   └── TimelineScreen.tsx          # 主容器 (✅ 重构完成)
├── components/
│   └── Timeline/
│       ├── index.ts                # 导出 (✅ 更新)
│       ├── TimelineViewSwitcher.tsx # 视图切换器 (✅ 新增)
│       ├── views/
│       │   ├── index.ts            # 视图导出 (✅ 新增)
│       │   ├── FocusView.tsx       # 「本周」水平分页 (✅ 新增)
│       │   ├── JourneyView.tsx     # 「旅程」垂直时间线 (✅ 新增)
│       │   └── GridView.tsx        # 「全览」网格 (✅ 新增)
│       ├── TrimesterHeader.tsx     # 保留
│       └── WeekCard.tsx            # 保留（JourneyView 使用）
└── state/
    ├── index.ts                    # 导出 (✅ 更新)
    └── timelineStore.ts            # Timeline 状态管理 (✅ 新增)
```

---

## 十、实施记录

### Phase A: 基础架构 ✅

| 任务 | 产出 | 状态 |
|-----|------|------|
| 创建 `timelineStore.ts` | 独立状态管理 | ✅ |
| 创建 `TimelineViewSwitcher` | 药丸形分段控制器 | ✅ |
| 重构 `TimelineScreen` | 视图容器 | ✅ |

### Phase B: Focus View ✅

| 任务 | 产出 | 状态 |
|-----|------|------|
| 创建 `FocusView` 组件 | 水平分页 + 动态宽度 | ✅ |
| 内联 FocusWeekCard | 全屏大卡片 | ✅ |
| 周指示器 | 底部 "X / 40" 显示 | ✅ |

### Phase C: Grid View ✅

| 任务 | 产出 | 状态 |
|-----|------|------|
| 创建 `GridView` 组件 | 响应式网格 (4/5列) | ✅ |
| 点击跳转逻辑 | setViewMode('focus', week) | ✅ |

### Phase D: Journey View ✅

| 任务 | 产出 | 状态 |
|-----|------|------|
| 创建 `JourneyView` 组件 | 垂直时间线 + 锚点同步 | ✅ |
| 复用 `WeekCard` | 保持原有展开逻辑 | ✅ |

### Phase E: 交互完善 ✅

| 任务 | 产出 | 状态 |
|-----|------|------|
| 锚点同步逻辑 | onViewableItemsChanged + lastViewedWeekByView | ✅ |
| 视图切换动画 | LayoutAnimation.easeInEaseOut | ✅ |
| 触觉反馈 | expo-haptics (已安装) | ✅ |

### Phase F: 审计与优化 ✅

| 任务 | 产出 | 状态 |
|-----|------|------|
| Codex 审计 | 锚点同步 bug 修复 | ✅ |
| Gemini 审计 | 触控目标 + a11y 修复 | ✅ |
| TypeScript 编译 | 无错误 | ✅ |

---

## 十一、Session 记录

### Codex Session (设计阶段)
- **SESSION_ID**: `019b443f-a05c-76e1-825c-9941353a9a23`
- **贡献**:
  - UX 痛点分析
  - 视图模式定义
  - 架构设计
  - 默认视图推荐

### Gemini Session (设计阶段)
- **SESSION_ID**: `dd8ff86a-0430-4bbc-87eb-5bfac0292ad3`
- **贡献**:
  - 视觉设计批评
  - "时间三态" 命名
  - 视图切换器 UI 设计
  - 样式规格建议

### Codex Session (实施审计)
- **SESSION_ID**: `019b444c-5d2c-7470-8e15-d53747c8e5bc`
- **贡献**:
  - 发现 Grid→Focus 锚点丢失 bug (HIGH)
  - 发现 JourneyView 滚动不同步 (MEDIUM)
  - 发现 FocusView 横屏布局问题 (LOW)

### Gemini Session (实施审计)
- **SESSION_ID**: `a4ddf22e-ec08-40a8-8fda-4795e9e46405`
- **贡献**:
  - 发现触控目标过小 (MEDIUM)
  - 发现缺少 tablist 角色 (MEDIUM)
  - 发现缺少触觉反馈 (HIGH)
  - 发现视图切换无动画 (LOW)

---

## 十二、验收标准

- [x] 三种视图模式均可正常切换
- [ ] 视图偏好在 APP 重启后保持（需添加 MMKV 持久化）
- [x] 跨视图锚点同步正确
- [x] 当前周在所有视图中均有明显高亮
- [x] 切换动画流畅 (< 250ms)
- [x] 触觉反馈正常工作
- [ ] 无性能问题 (FPS > 55)（待实机测试）
- [x] 通过 Codex + Gemini 代码审计

---

## 十三、新增依赖

| 包名 | 版本 | 用途 |
|-----|------|------|
| `expo-haptics` | latest | 触觉反馈 |

---

## 十四、待优化项

| 优先级 | 任务 | 描述 |
|-------|------|------|
| P1 | MMKV 持久化 | 保存 viewMode 到本地存储 |
| P2 | 脉冲动画 | 当前周节点呼吸动画 |
| P2 | 吸顶进度条 | JourneyView 顶部进度指示 |
| P3 | 共享元素转场 | Grid→Focus 缩放动画 |

---

**文档版本**: v2.0
**最后更新**: 2024-12-22
