# 伴生 - 开发方案

> **文档创建日期**: 2024-12-19
> **参与模型**: Claude (主控) + Codex + Gemini
> **状态**: ✅ Phase 5 情感功能已完成，项目核心功能开发完毕

---

## 一、项目概览

### 1.1 项目定位

| 项目 | 决策 | 状态 |
|------|------|------|
| **APP名称** | **伴生** | ✅ 已确认 |
| **技术栈** | React Native + TypeScript | ✅ 已确认 |
| **目标平台** | Android 优先，Web 预览支持 | ✅ 已确认 |
| **核心用户** | 准爸爸视角 | ✅ 已确认 |
| **AI接入** | 用户自配置API（OpenAI/Claude/自定义端点） | ✅ 已确认 |

### 1.2 核心理念

> **"AI没有知识库就是废物。"**
>
> 我们不是在做"AI聊天APP"，我们是在做一个**结构化的孕期知识系统**，AI只是这个系统的"嘴"。

**产品定位对比：**

| 传统孕期APP | 伴生 |
|------------|-----------|
| 信息展示 | **行动指令** |
| 被动记录 | **主动推送任务** |
| 你问我答 | **我预判你需要什么** |
| 功能堆砌 | **情境感知** |
| 妈妈视角 | **爸爸专属视角** |

---

## 二、核心架构

### 2.1 系统架构图

```
┌─────────────────────────────────────────────────────────┐
│                    用户看到的                            │
│                   「对话界面」                           │
│                  (Chat-First UI)                        │
└─────────────────────────────────────────────────────────┘
                          ▲
                          │ 生成回复
                          │
┌─────────────────────────────────────────────────────────┐
│                   AI表达层                               │
│         (LLM只负责把结构化数据变成自然语言)                │
└─────────────────────────────────────────────────────────┘
                          ▲
                          │ 检索
                          │
┌─────────────────────────────────────────────────────────┐
│                 ★ 核心知识库 ★                          │
│    (这才是真正的价值，AI只是传话筒)                       │
│                                                         │
│  ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐       │
│  │ 40周数据 │ │ 食物库  │ │ 症状库  │ │ 情绪脚本 │       │
│  └─────────┘ └─────────┘ └─────────┘ └─────────┘       │
│  ┌─────────┐ ┌─────────┐                               │
│  │ 应急流程 │ │ 任务库  │                               │
│  └─────────┘ └─────────┘                               │
└─────────────────────────────────────────────────────────┘
```

### 2.2 技术选型

| 类别 | 选择 | 理由 | 状态 |
|------|------|------|------|
| **框架** | React Native + TypeScript | 跨平台，生态成熟 | ✅ 已确认 |
| **数据库** | SQLite (expo-sqlite) | 轻量、可靠、离线优先 | ✅ 已确认 |
| **Web 兼容** | react-native-web + localStorage | Web 预览支持 | ✅ 已确认 |
| **状态管理** | Zustand | 轻量、简单 | ✅ 已确认 |
| **导航** | React Navigation | 生态成熟 | ✅ 已确认 |
| **聊天UI** | react-native-gifted-chat | 可定制性强 | ✅ 已确认 |
| **图表** | Victory Native / RN SVG | 体重趋势图等 | ✅ 已确认 |
| **通知** | expo-notifications | 产检提醒等 | ✅ 已确认 |
| **日期处理** | dayjs | 轻量 | ✅ 已确认 |
| **数据校验** | zod | 类型安全 | ✅ 已确认 |
| **本地存储** | MMKV | 快速KV存储 | ✅ 已确认 |

### 2.3 项目结构（已实现）

```
app/                          # Expo 项目根目录
├── App.tsx                   # ✅ 应用入口（平台检测+条件加载数据库）
├── src/
│   ├── constants/            # ✅ 常量配置
│   │   ├── index.ts          # 常量导出
│   │   └── theme.ts          # 主题配置（颜色、排版、间距）
│   ├── navigation/           # ✅ 导航配置
│   │   ├── index.ts          # 导航导出
│   │   ├── types.ts          # 导航类型定义
│   │   ├── RootNavigator.tsx # 根导航器（Stack）
│   │   └── MainTabNavigator.tsx # 底部标签导航
│   ├── screens/              # ✅ 页面组件
│   │   ├── index.ts          # 页面导出
│   │   ├── HomeScreen.tsx    # ✅ 首页 Dashboard（任务卡片+孕周信息+FAB+成长卡片）
│   │   ├── TimelineScreen.tsx # ✅ 40周时间线（FlatList+可展开卡片+三孕期分隔）
│   │   ├── ToolsScreen.tsx   # ✅ 工具页（2x2网格入口）
│   │   ├── ContractionTimerScreen.tsx # ✅ 宫缩计时器（5-1-1检测+XP+成就）
│   │   ├── KickCounterScreen.tsx # ✅ 胎动计数器（环形进度+XP）
│   │   ├── HospitalBagScreen.tsx # ✅ 待产包清单（4分类折叠+成就）
│   │   ├── EmergencyContactsScreen.tsx # ✅ 紧急联系人（一键拨打+XP+成就）
│   │   ├── AssistantScreen.tsx # ✅ AI助手（完整对话界面）
│   │   ├── ProfileScreen.tsx # 个人设置
│   │   ├── OnboardingScreen.tsx # ✅ 引导页（多步骤流程）
│   │   ├── AIConfigScreen.tsx # ✅ AI配置页面
│   │   ├── MilestoneScreen.tsx # ✅ 里程碑时间线
│   │   ├── AddMilestoneScreen.tsx # ✅ 添加里程碑（模板+自定义）
│   │   └── AchievementsScreen.tsx # ✅ 成就墙（分类展示+统计）
│   ├── services/             # ✅ 服务层
│   │   ├── index.ts          # 服务导出
│   │   ├── db/
│   │   │   ├── index.ts      # 数据库导出（原生平台）
│   │   │   ├── index.web.ts  # ✅ Web 平台 stub（localStorage）
│   │   │   ├── userDb.ts     # 数据库初始化和表结构
│   │   │   └── queries.ts    # 数据库查询函数
│   │   ├── kb/               # ✅ 知识库服务
│   │   │   ├── index.ts      # KB服务导出
│   │   │   ├── knowledgeDb.ts # KB数据库schema + seed函数
│   │   │   ├── kbService.ts  # KB查询服务（FTS5搜索）
│   │   │   ├── kbInit.ts     # KB初始化（版本管理+数据导入）
│   │   │   └── intentDetector.ts # 意图检测（关键词匹配）
│   │   └── ai/               # ✅ AI Provider 抽象层
│   │       ├── index.ts      # AI服务入口 + 工厂函数
│   │       ├── types.ts      # AI类型定义
│   │       ├── context.ts    # ✅ 上下文注入（系统提示词构建+KB增强）
│   │       └── providers/    # Provider 实现
│   │           ├── index.ts
│   │           ├── openai.ts # OpenAI 兼容
│   │           ├── claude.ts # Claude API
│   │           └── custom.ts # 自定义端点
│   ├── state/                # ✅ Zustand stores
│   │   ├── index.ts          # 状态导出
│   │   ├── pregnancyStore.ts # 孕期状态管理
│   │   ├── chatStore.ts      # 聊天状态管理
│   │   └── dadStore.ts       # ✅ 爸爸成长状态（XP/等级/成就）
│   ├── types/                # ✅ TypeScript 类型
│   │   └── index.ts          # 核心类型定义
│   ├── components/           # ✅ UI组件
│   │   ├── index.ts          # 组件导出
│   │   ├── Button.tsx        # 通用按钮
│   │   ├── WeekIndicator.tsx # 孕周进度指示器
│   │   ├── DadLevelCard.tsx  # ✅ 爸爸等级卡片（XP进度+等级展示）
│   │   ├── Chat/             # ✅ 对话组件
│   │   │   ├── index.ts
│   │   │   ├── ContextBar.tsx    # 上下文显示
│   │   │   ├── QuickChips.tsx    # 快捷建议
│   │   │   ├── ChatInput.tsx     # 消息输入
│   │   │   └── MessageBubble.tsx # 消息气泡
│   │   └── Cards/            # ✅ 卡片组件
│   │       ├── index.ts
│   │       ├── TaskCard.tsx      # 任务卡片
│   │       └── AppointmentCard.tsx # 预约卡片
│   │   ├── Timeline/         # ✅ 时间线组件
│   │       ├── index.ts
│   │       ├── TrimesterHeader.tsx # 三孕期分隔头
│   │       └── WeekCard.tsx      # 可展开周卡片
│   ├── hooks/                # ✅ React Hooks
│   │   ├── index.ts
│   │   └── useChat.ts        # ✅ 对话逻辑 Hook（含KB意图检测+上下文注入）
│   ├── lib/                  # ✅ 工具函数
│   │   ├── index.ts
│   │   └── pregnancy.ts      # ✅ 孕期计算（周数、宝宝大小）
│   ├── knowledge/            # ✅ 知识库JSON数据
│   │   ├── foods.json        # 49条食物安全数据
│   │   ├── symptoms.json     # 22条症状决策树
│   │   ├── emotional.json    # 30条情绪场景剧本
│   │   └── emergencies.json  # 7条应急流程
│   ├── data/                 # ✅ 静态数据
│   │   └── weeklyData.ts     # 40周完整孕期数据（350行）
│   ├── features/             # ❌ 待开发 - 功能模块
│   └── assets/               # ❌ 待开发 - 静态资源
```

---

## 三、知识库设计（核心资产）

### 3.1 知识库规模

| 类别 | 数量 | 状态 | 备注 |
|------|------|------|------|
| **40周数据** | 40条 | ✅ 已完成 | 每条约500字，需医学审核 |
| **食物安全库** | 150+条 | ✅ 已完成 | 8大分类，详见 `20251219-食物安全库.md` |
| **症状决策树** | 22条 | ✅ 已完成 | 含分诊流程，详见 `20251219-症状决策树.md` |
| **情绪场景剧本** | 30条 | ✅ 已完成 | 9大场景类别，详见 `20251219-情绪场景剧本.md` |
| **应急流程** | 7条 | ✅ 已完成 | 待医学审核⚠️，详见 `20251219-应急流程.md` |
| **周任务库** | 140+条 | ✅ 已完成 | 40周完整任务，详见 `20251219-周任务库.md` |

### 3.2 40周数据结构（已完成示例）

**已完成示例周数：**
- ✅ 第6周 - 孕早期最敏感时期
- ✅ 第12周 - 流产风险大降（过渡期）
- ✅ 第24周 - 孕中期黄金期
- ✅ 第32周 - 冲刺准备期
- ✅ 第38周 - 随时待命（足月）

**数据结构定义：**

```yaml
week: X                           # 孕周数
trimester: 1/2/3                  # 孕期
gestational_days: X-X             # 孕天范围

baby:                             # 宝宝发育
  size:
    length_cm: X
    weight_g: X
    comparison: "像XX一样大"       # 生动比喻
  developments: []                # 发育要点（3-5条）
  what_dad_can_do: []             # 爸爸能做的互动

mother:                           # 妈妈状态
  physical_symptoms:              # 身体症状
    - symptom: 症状名
      probability: 0.X            # 发生概率
      cause: 原因
      when: 高发时间
      dad_action: 爸爸具体行动

  emotional_state:                # 情绪状态
    - state: 情绪
      cause: 原因
      dad_should: 应该做什么
      dad_should_not: 不该做什么

  warning_signs:                  # ⚠️ 危险信号（救命信息）
    - symptom: 症状描述
      possible_condition: 可能情况
      urgency: EMERGENCY/HIGH/MEDIUM
      action: 具体行动

dad_actions:                      # 爸爸行动清单
  daily_morning: []               # 每天早上
  daily_evening: []               # 每天晚上
  this_week_tasks: []             # 本周任务
  what_to_prepare: []             # 需要准备的东西

nutrition:                        # 营养指南
  focus_nutrients: []
  recommended_foods: []
  avoid_foods: []
  meal_suggestion:
    breakfast: 建议
    lunch: 建议
    dinner: 建议

medical:                          # 医疗检查
  scheduled_checkups:
    - name: 检查名
      purpose: 目的
      what_to_expect: 预期
      dad_role: 爸爸角色

dad_tip_of_week: "本周最重要的一句话"
```

### 3.3 食物安全数据结构（待开发）

```yaml
id: food_id
name: 食物名称
aliases: [别名1, 别名2]
category: 分类

safety_level: SAFE/MODERATE/AVOID/FORBIDDEN

scientific_view:
  verdict: 结论
  explanation: 科学解释
  conditions: [注意事项]
  frequency: 建议频率
  portion: 建议份量

traditional_chinese_view:
  verdict: 传统观点
  explanation: 解释
  scientific_basis: 是否有科学依据

allergen_warning: true/false
preparation: [准备方法]
alternatives: [替代食物]

response_template: |
  AI回复的模板文本
```

### 3.4 症状决策树结构（待开发）

```yaml
id: symptom_id
name: 症状名称
aliases: [别名]

triage_flow:
  - question: 问题
    options:
      - answer: 回答
        leads_to: 下一步
        urgency: 紧急程度

decision_matrix:
  emergency:
    conditions: [触发条件]
    response: 响应模板
  high:
    conditions: []
    response: 响应模板
  low:
    conditions: []
    likely: 可能原因
    response: 响应模板
```

### 3.5 情绪场景剧本结构（待开发）

```yaml
id: scenario_id
name: 场景名称
triggers: [触发关键词]

context:
  facts: [相关事实]
  psychology: [心理分析]

wrong_responses:
  - text: 错误回应
    why_wrong: 为什么错
    her_thought: 她会怎么想

right_responses:
  - text: 正确回应
    why_works: 为什么有效

follow_up_actions: [后续行动建议]

response_template: |
  AI回复的模板
```

---

## 四、核心功能设计

### 4.1 功能优先级

#### Phase 1: 基础框架 + 核心知识（MVP）✅ 已完成

| 功能 | 描述 | 状态 |
|------|------|------|
| 项目初始化 | RN + TS + Expo 基础配置 | ✅ 已完成 |
| 数据库设置 | SQLite schema + 初始化 | ✅ 已完成 |
| 导航结构 | 底部标签 + 原生栈导航 | ✅ 已完成 |
| 状态管理 | Zustand stores (pregnancy/chat) | ✅ 已完成 |
| 类型系统 | TypeScript 类型定义 | ✅ 已完成 |
| 引导页 | 设置预产期（占位） | ✅ 已完成 |
| 40周数据 | 完整40周知识库 | ✅ 已完成 |

#### Phase 2: 核心交互 ✅ 已完成

| 功能 | 描述 | 状态 |
|------|------|------|
| 引导流程 | 多步骤引导（欢迎+预产期选择） | ✅ 已完成 |
| AI Provider 抽象层 | OpenAI/Claude/自定义端点支持 | ✅ 已完成 |
| AI 配置界面 | 用户配置API密钥和模型 | ✅ 已完成 |
| 上下文注入 | AI知道当前孕周、宝宝大小等 | ✅ 已完成 |
| 对话界面 | Chat-first UI（消息气泡+快捷建议） | ✅ 已完成 |
| 首页Dashboard | 孕周进度+每日任务+宝宝大小+FAB | ✅ 已完成 |
| Web 平台支持 | react-native-web + localStorage shim | ✅ 已完成 |

#### Phase 3: 知识库集成 ✅ 已完成

| 功能 | 描述 | 状态 |
|------|------|------|
| 知识库数据库 | SQLite schema + FTS5 全文搜索 | ✅ 已完成 |
| 意图检测 | 关键词匹配（食物/症状/情绪/紧急） | ✅ 已完成 |
| KB上下文注入 | AI系统提示词增强 | ✅ 已完成 |
| 食物安全查询 | 49条食物数据（FTS5搜索） | ✅ 已完成 |
| 症状分析 | 22条症状决策树 | ✅ 已完成 |
| 情绪教练 | 30条场景剧本 | ✅ 已完成 |
| 应急流程 | 7条紧急处理流程 | ✅ 已完成 |

#### Phase 4: 工具功能 ✅ 已完成

| 功能 | 描述 | 状态 |
|------|------|------|
| 宫缩计时器 | 记录宫缩间隔（含5-1-1规律检测） | ✅ 已完成 |
| 胎动计数器 | 记录胎动（环形进度显示） | ✅ 已完成 |
| 待产包清单 | 可勾选清单（4分类折叠） | ✅ 已完成 |
| 紧急联系人 | 一键拨打（优先级排序） | ✅ 已完成 |

#### Phase 5: 情感功能 ✅ 已完成

| 功能 | 描述 | 状态 |
|------|------|------|
| 里程碑记录 | 重要时刻记录（添加/展示/标记高光） | ✅ 已完成 |
| 爸爸成长系统 | XP获取/等级/成就解锁/成就墙 | ✅ 已完成 |
| 成就触发集成 | 工具页触发成就（宫缩/胎动/待产包/联系人） | ✅ 已完成 |

### 4.2 核心交互设计

#### 4.2.1 每日任务推送

**早晨打开APP看到的不是信息堆砌，而是行动指令：**

```
┌─────────────────────────────────────────┐
│  📅 第24周第3天 | 👶 玉米棒大小          │
│  ─────────────────────────────────────  │
│  早上好，队长。                          │
│                                         │
│  她今天可能腰酸背痛，因为宝宝重心在转移。  │
│                                         │
│  你的任务：                              │
│  别问"我能帮什么"，直接把热水袋加热好，   │
│  她坐下时放到她背后。                    │
│                                         │
│  [任务已接受 ✓]                          │
└─────────────────────────────────────────┘
```

#### 4.2.2 紧急情况响应

**3秒内给出行动指南：**

```
┌─────────────────────────────────────────┐
│ ⚠️ 紧急模式                              │
│ ────────────────────────────────────── │
│                                         │
│  她有没有这些情况？                      │
│                                         │
│  [大量出血]  [剧烈腹痛]  [破水]           │
│                                         │
│ ────────────────────────────────────── │
│                                         │
│  📞 [一键拨打急救 120]                    │
│                                         │
│  📍 [发送当前位置给家人]                  │
│                                         │
│  📋 [去医院需要带什么]                    │
│                                         │
└─────────────────────────────────────────┘
```

#### 4.2.3 导航模式

**不用传统Tab栏，用「模式切换」：**

```
┌─────────────────────────────────────────┐
│     🎯 专注模式（默认）                   │
│     每日任务 + AI对话                    │
├─────────────────────────────────────────┤
│     📅 时间线模式                        │
│     40周旅程纵览                         │
├─────────────────────────────────────────┤
│     💝 回忆模式                          │
│     宝宝信箱 + 里程碑 + 爸爸日志          │
└─────────────────────────────────────────┘
```

---

## 五、数据库设计

### 5.1 数据库分离策略

```
knowledge.db (只读，可更新)
├── weeks          # 40周数据
├── foods          # 食物安全
├── symptoms       # 症状决策树
├── scenarios      # 情绪场景
├── emergencies    # 应急流程
├── tasks          # 任务模板
└── manifest       # 版本信息

user.db (用户数据)
├── profile        # 用户配置
├── symptom_logs   # 症状记录
├── weight_records # 体重记录
├── appointments   # 产检预约
├── kicks          # 胎动记录
├── contractions   # 宫缩记录
├── checklists     # 清单状态
├── journal        # 日记
├── letters        # 给宝宝的信
├── milestones     # 里程碑
├── ai_config      # AI配置
├── chat_history   # 聊天历史
└── cached_answers # 缓存的AI回答
```

### 5.2 核心表结构

#### knowledge.db

```sql
-- 40周数据
CREATE TABLE weeks (
  week INTEGER PRIMARY KEY,
  data JSON NOT NULL,
  version TEXT,
  updated_at TEXT
);

-- 食物安全
CREATE TABLE foods (
  id TEXT PRIMARY KEY,
  name TEXT NOT NULL,
  category TEXT,
  safety TEXT,
  data JSON NOT NULL,
  locale TEXT DEFAULT 'zh-CN'
);

-- 症状决策树
CREATE TABLE symptoms (
  id TEXT PRIMARY KEY,
  name TEXT NOT NULL,
  triage JSON NOT NULL,
  red_flags JSON,
  home_care JSON
);

-- 情绪场景
CREATE TABLE scenarios (
  id TEXT PRIMARY KEY,
  name TEXT NOT NULL,
  data JSON NOT NULL,
  locale TEXT DEFAULT 'zh-CN'
);

-- 应急流程
CREATE TABLE emergencies (
  id TEXT PRIMARY KEY,
  name TEXT NOT NULL,
  data JSON NOT NULL
);

-- 版本管理
CREATE TABLE manifest (
  id INTEGER PRIMARY KEY,
  version TEXT NOT NULL,
  hash TEXT NOT NULL,
  updated_at TEXT
);
```

#### user.db

```sql
-- 用户配置
CREATE TABLE profile (
  id INTEGER PRIMARY KEY,
  due_date TEXT NOT NULL,
  start_date TEXT,
  partner_name TEXT,
  locale TEXT DEFAULT 'zh-CN',
  created_at TEXT,
  updated_at TEXT
);

-- AI配置
CREATE TABLE ai_config (
  id INTEGER PRIMARY KEY,
  provider TEXT NOT NULL,
  base_url TEXT,
  api_key TEXT,
  model TEXT,
  updated_at TEXT
);

-- 聊天历史
CREATE TABLE chat_history (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  role TEXT NOT NULL,
  content TEXT NOT NULL,
  timestamp TEXT NOT NULL,
  context JSON
);

-- 症状记录
CREATE TABLE symptom_logs (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  date TEXT NOT NULL,
  symptom_type TEXT NOT NULL,
  severity INTEGER,
  notes TEXT,
  created_at TEXT
);

-- 体重记录
CREATE TABLE weight_records (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  date TEXT UNIQUE NOT NULL,
  weight REAL NOT NULL,
  created_at TEXT
);

-- 产检预约
CREATE TABLE appointments (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  date TEXT NOT NULL,
  title TEXT NOT NULL,
  location TEXT,
  reminder_minutes INTEGER,
  notes TEXT,
  created_at TEXT
);

-- 胎动记录
CREATE TABLE kicks (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  session_start TEXT NOT NULL,
  session_end TEXT,
  count INTEGER DEFAULT 0,
  created_at TEXT
);

-- 宫缩记录
CREATE TABLE contractions (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  start_time TEXT NOT NULL,
  end_time TEXT,
  duration_seconds INTEGER,
  intensity INTEGER,
  notes TEXT,
  created_at TEXT
);

-- 紧急联系人
CREATE TABLE emergency_contacts (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  name TEXT NOT NULL,
  relation TEXT NOT NULL,
  phone TEXT NOT NULL,
  priority INTEGER DEFAULT 0,
  created_at TEXT
);

-- 里程碑记录
CREATE TABLE milestones (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  week INTEGER NOT NULL,
  title TEXT NOT NULL,
  description TEXT,
  photo_uri TEXT,
  is_highlight INTEGER DEFAULT 0,
  created_at TEXT NOT NULL
);

-- 爸爸成长主表
CREATE TABLE dad_growth (
  id INTEGER PRIMARY KEY CHECK (id = 1),
  total_xp INTEGER DEFAULT 0,
  level INTEGER DEFAULT 1,
  created_at TEXT NOT NULL,
  updated_at TEXT NOT NULL
);

-- XP 事件记录
CREATE TABLE xp_events (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  event_type TEXT NOT NULL,
  xp_amount INTEGER NOT NULL,
  source_id INTEGER,
  source_type TEXT,
  created_at TEXT NOT NULL
);

-- 成就定义
CREATE TABLE achievements (
  id TEXT PRIMARY KEY,
  title TEXT NOT NULL,
  description TEXT NOT NULL,
  icon TEXT NOT NULL,
  category TEXT NOT NULL,
  points INTEGER DEFAULT 10,
  required_progress INTEGER DEFAULT 1,
  created_at TEXT
);

-- 用户成就进度
CREATE TABLE user_achievements (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  achievement_id TEXT NOT NULL UNIQUE,
  current_progress INTEGER DEFAULT 0,
  unlocked INTEGER DEFAULT 0,
  unlocked_at TEXT,
  FOREIGN KEY (achievement_id) REFERENCES achievements(id)
);
```

---

## 六、AI集成设计

### 6.1 核心原则

> **检索优先，生成其次**
>
> AI不是知识来源，只是表达工具。所有关键信息必须来自结构化知识库。

### 6.2 AI调用流程

```
用户输入: "她今天头疼"
         ↓
┌─────────────────────────────────────┐
│  1. 意图识别：症状查询               │
│  2. 从症状库检索 headache.yaml      │
│  3. 获取当前孕周上下文 (week 24)    │
│  4. 检索该周的 warning_signs        │
│  5. 匹配危险信号                    │
└─────────────────────────────────────┘
         ↓
┌─────────────────────────────────────┐
│  LLM任务：把结构化数据变成自然语言   │
│  输入：症状、危险信号、建议行动      │
│  输出：简洁、可行动的回复           │
└─────────────────────────────────────┘
         ↓
AI回复（结构化+自然语言混合）
```

### 6.3 安全策略

```typescript
// 危险信号必须从知识库硬编码，不让LLM自由生成
if (symptomData.urgency === 'EMERGENCY') {
  // 直接渲染预设模板，不调用LLM
  return renderEmergencyTemplate(symptomData);
}
```

### 6.4 AI Provider 抽象层

```typescript
interface IAiProvider {
  id: string;
  name: string;
  models?: string[];
  chat(messages: Message[], context: Context, options?: Options): Promise<Response>;
}

// 实现
class OpenAIProvider implements IAiProvider { ... }
class ClaudeProvider implements IAiProvider { ... }
class CustomProvider implements IAiProvider { ... }
```

---

## 七、UI/UX设计

### 7.1 设计语言

| 元素 | 选择 | 理由 |
|------|------|------|
| **主色调** | 岩蓝 #475569 | 可靠、沉稳、适合爸爸 |
| **辅助色** | 灰绿 #84A98C | 成长、和谐 |
| **强调色** | 赤陶 #E07A5F | 紧急/爱心动作 |
| **背景色** | 米白 #F8F9FA | 舒适护眼 |
| **字体** | 系统默认 | 跨平台兼容 |
| **图标风格** | 线条图标，圆角 | 简洁友好 |

### 7.2 AI人格设计

| 属性 | 设计 |
|------|------|
| **称呼** | "Chief" 或用户自定义 |
| **语气** | 专业但温暖，像一个靠谱的老大哥 |
| **特点** | 简洁、可行动、不说废话 |

**语气示例：**

```
❌ 错误: "请确保她保持充足的水分摄入。"（太机械）
❌ 错误: "兄弟，快给她倒杯水！"（太随意）
✅ 正确: "补水很重要。现在就倒杯水递给她，别等她开口要。"
```

---

## 八、开发会话记录

### 8.1 Codex 会话

- **SESSION_ID**: `019b3528-c2e9-7e41-817b-7032ef6687cf`
- **主要贡献**:
  - 技术架构设计
  - 知识库数据结构定义
  - 数据库schema设计
  - AI集成策略
  - 40周数据示例（第6、24、38周）

### 8.2 Gemini 会话

- **SESSION_ID**: `bdf80ee4-6d8c-42f8-bf3e-16e8be7b92e8`
- **主要贡献**:
  - UI/UX设计方案
  - 交互模式创新（对话优先、模式切换）
  - 情感化设计元素
  - 40周数据示例（第12、32周）
  - 待产包清单等实用内容

---

## 九、待完善事项清单

### 9.1 高优先级（必须在开发前完成）

| 事项 | 状态 | 负责 |
|------|------|------|
| APP名称确定 | ✅ 已确认「伴生」 | 用户 |
| 完整40周数据（剩余35周） | ✅ 已完成40周 | Claude + Codex + Gemini |
| 知识库内容医学审核策略 | ❌ 待确定 | 用户 |

### 9.2 中优先级（可与开发并行）

| 事项 | 状态 | 备注 |
|------|------|------|
| 食物安全库（150+条） | ✅ 已完成 | ⚠️ 待专业审核（传统说法vs现代医学） |
| 症状决策树（22条） | ✅ 已完成 | ⚠️ 待专业审核（分诊逻辑） |
| 情绪场景剧本（30条） | ✅ 已完成 | ✅ AI审核通过 |
| 应急流程（7条） | ✅ 已完成 | 🔴 必须专业医疗人员审核 |
| 周任务库（140+条） | ✅ 已完成 | ⚠️ 需本地化（疫苗名称等） |

### 9.2.1 AI审核发现的问题（已修正）

| 知识库 | 问题项 | 建议 | 状态 |
|--------|--------|------|------|
| 食物安全库 | 桂圆/山楂/薏米标记为AVOID | 传统说法，现代医学无明确禁忌，建议改为CAUTION | ✅ 已修正：新增3条CAUTION级别条目 |
| 症状决策树 | 胎动"2小时<10次"标准 | 建议改为"1小时<10次（进食后）" | ✅ 已修正：更新为"进食后1小时内" |
| 应急流程 | 孕晚期CPR体位 | 需添加"右侧垫物使身体左倾15-30度" | ✅ 已修正：添加左倾体位+手动推子宫备用方案 |
| 周任务库 | W27 Tdap疫苗 | 中国应改为"百白破疫苗" | ✅ 原已本地化（weeklyData.ts第381行） |

### 9.3 低优先级（后续迭代）

| 事项 | 状态 | 备注 |
|------|------|------|
| 中国特色功能（农历、坐月子） | ❌ 待设计 | 可选功能 |
| 爸爸成长系统（XP、成就） | ❌ 待设计 | 情感功能 |
| 数据导出（PDF书籍） | ❌ 待设计 | 情感功能 |

---

## 十、下一步行动

### 10.1 已完成

1. ~~**Phase 1: 基础框架**~~ ✅
   - React Native + Expo + TypeScript 基础框架
   - SQLite schema + 初始化 + 查询函数
   - 底部标签导航 + 原生栈导航
   - Zustand stores (pregnancy/chat)
   - 完整 TypeScript 类型定义

2. ~~**Phase 2: 核心交互**~~ ✅
   - 引导流程（多步骤：欢迎→预产期选择）
   - AI Provider 抽象层（OpenAI/Claude/自定义）
   - AI 配置界面
   - 上下文注入（系统提示词含孕周信息）
   - 对话界面（消息气泡+快捷建议+输入框）
   - 首页 Dashboard（孕周进度+任务卡片+宝宝大小+FAB）
   - Web 平台支持（react-native-web + localStorage shim）

3. ~~**Phase 3: 知识库集成**~~ ✅
   - 知识库SQLite schema（FTS5全文搜索）
   - 意图检测器（关键词匹配：食物/症状/情绪/紧急）
   - KB上下文注入（AI系统提示词增强）
   - 数据导入管道（YAML→JSON→SQLite）
   - 食物安全查询（49条，FTS5搜索）
   - 症状决策树（22条）
   - 情绪场景剧本（30条）
   - 应急流程（7条）

4. ~~**Phase 4: 工具功能**~~ ✅
   - ToolsScreen 网格入口（2x2卡片布局）
   - 宫缩计时器（记录间隔/持续时间，5-1-1规律检测）
   - 胎动计数器（环形进度显示，目标10次）
   - 待产包清单（4分类折叠，预置默认清单）
   - 紧急联系人（优先级排序，一键拨打）
   - 审计修复（逻辑修正+可访问性改进）

### 10.2 当前阶段：核心功能开发完毕

Phase 1-5 全部完成。项目核心功能开发完毕，可进入测试和优化阶段。

5. ~~**Phase 5: 情感功能**~~ ✅
   - 里程碑记录（MilestoneScreen + AddMilestoneScreen）
   - 爸爸成长系统（XP + 等级 + DadLevelCard）
   - 成就系统（8个默认成就 + AchievementsScreen）
   - 工具页成就触发（宫缩/胎动/待产包/紧急联系人）

### 10.3 后续迭代（可选）

| 事项 | 状态 | 备注 |
|------|------|------|
| 中国特色功能（农历、坐月子） | ❌ 待设计 | 可选功能 |
| 数据导出（PDF书籍） | ❌ 待设计 | 情感功能扩展 |
| 多语言支持 | ❌ 待设计 | 国际化 |
| 云同步备份 | ❌ 待设计 | 数据安全 |

---

## 附录：40周数据完整示例

### A.1 第6周示例

```yaml
week: 6
trimester: 1
gestational_days: 36-42

baby:
  size:
    length_cm: 0.6
    weight_g: 1
    comparison: "像一颗扁豆那么大"

  developments:
    - 心管开始跳动，B超可能可见原始心跳（约110-120次/分）
    - 神经管即将闭合，形成大脑和脊髓雏形
    - 面部轮廓出现：眼睛凹陷、肢芽开始形成
    - 胎盘和脐带形成，开始向宝宝输送营养

  what_dad_can_do:
    - 确保她按时吃叶酸（神经管发育关键期）
    - 帮忙避免刺鼻气味（油烟、香水）——这些会加重孕吐
    - 提供小份零食（苏打饼干、酸梅）缓解恶心
    - 什么都不用说，陪着她就好

mother:
  physical_symptoms:
    - symptom: 孕吐/恶心
      probability: 0.70
      cause: HCG激素急剧上升刺激胃部
      when: 早晨空腹时最严重，也可能全天
      dad_action: |
        准备苏打饼干放床头，她醒来前吃几片再起床
        避免做油腻的饭菜
        不要问"今天感觉怎么样"——她一定很难受

    - symptom: 极度疲劳
      probability: 0.60
      cause: 孕酮飙升 + 身体在建造胎盘
      when: 全天，尤其下午
      dad_action: |
        让她多休息，不要安排社交活动
        主动承担所有家务
        如果她睡着了，不要叫醒她

    - symptom: 乳房胀痛
      probability: 0.50
      cause: 激素变化导致乳腺发育
      when: 全天，触碰时加重
      dad_action: |
        亲密时要特别轻柔
        帮她选购无钢圈内衣

    - symptom: 轻微腹部坠胀感
      probability: 0.40
      cause: 子宫开始增大
      when: 久站或姿势变换时
      dad_action: 让她多休息，不要让她搬重物

  emotional_state:
    - state: 情绪波动大/易哭
      cause: 激素剧变 + 身体不适 + 对未知的担忧
      dad_should: |
        无条件接纳，不要试图"讲道理"
        说"我陪着你""你辛苦了"
        给她一个拥抱
      dad_should_not: |
        说"你怎么又哭了"
        说"这有什么好哭的"
        试图用逻辑解决情绪问题

    - state: 焦虑（担心流产）
      cause: 知道这是流产高风险期（约15-20%）
      dad_should: |
        陪她一起关注，但不要过度紧张
        确保叶酸按时吃、休息到位
        如果她想查资料，陪她一起查
      dad_should_not: |
        说"没事的，别瞎想"（她的担心是合理的）
        说"网上说的不准"
        自己也表现得很焦虑

  warning_signs:
    - symptom: 阴道出血（尤其鲜红色）
      possible_condition: 先兆流产 / 宫外孕
      urgency: EMERGENCY
      action: |
        立即去医院妇产科急诊
        让她平躺，不要走动
        带上身份证和医保卡

    - symptom: 剧烈单侧下腹痛 + 头晕
      possible_condition: 宫外孕破裂（可能危及生命）
      urgency: EMERGENCY
      action: |
        立即拨打120
        让她平躺，不要吃喝
        这是急症，不要自己开车去医院

    - symptom: 发烧超过38°C持续2小时以上
      possible_condition: 感染
      urgency: HIGH
      action: |
        联系医生，询问是否需要就医
        不要自行服用退烧药（很多药物孕期禁用）

    - symptom: 严重呕吐（连水都喝不下）
      possible_condition: 妊娠剧吐，可能脱水
      urgency: HIGH
      action: |
        联系医生，可能需要输液补水
        不要硬撑

dad_actions:
  daily_morning:
    - action: 准备苏打饼干和温水放床头
      why: 空腹起床会加重孕吐，吃几片再起来能缓解

    - action: 做饭时开抽油烟机，避免油烟味飘进卧室
      why: 油烟味是常见的孕吐触发因素

  daily_evening:
    - action: 提前准备好第二天的简单早餐
      why: 减少早上厨房油烟

    - action: 让她早点休息，手机放远一点
      why: 充足睡眠对激素稳定和缓解疲劳至关重要

  this_week_tasks:
    - task: 预约第一次产检（确认宫内孕、心跳）
      deadline: 尽快
      why: 排除宫外孕，确认胚胎发育正常

    - task: 确认她每天在吃0.4mg叶酸
      deadline: 立即
      why: 神经管闭合的关键期，叶酸能预防神经管缺陷

    - task: 和她商量什么时候告诉家人/朋友
      deadline: 本周讨论
      why: 很多人选择12周后再公开，但也需要有人知道以便帮忙

  what_to_prepare:
    - item: 叶酸补充剂（如果还没买）
      why: 神经管发育必需

    - item: 苏打饼干、话梅、姜糖
      why: 缓解孕吐的常备零食

    - item: 无钢圈内衣
      why: 乳房胀痛时更舒适

nutrition:
  focus_nutrients:
    - 叶酸（400-800mcg/天）
    - 维生素B6（缓解孕吐）

  recommended_foods:
    - 深绿色叶菜（菠菜、西兰花）
    - 全谷物（燕麦、糙米）
    - 香蕉（补充B6和钾）
    - 柠檬水（缓解恶心）

  avoid_foods:
    - 生鱼片、生肉
    - 酒精（绝对禁止）
    - 高汞鱼类（金枪鱼、剑鱼）
    - 未经巴氏消毒的奶制品

  meal_suggestion:
    breakfast: 全麦吐司 + 水煮蛋 + 温牛奶（少量多次）
    lunch: 清蒸鱼/鸡胸肉 + 蔬菜 + 小份米饭
    dinner: 小米粥 + 清炒时蔬 + 瘦肉（清淡为主）

medical:
  scheduled_checkups:
    - name: 第一次产检（建卡）
      purpose: 确认宫内孕、胎心、排除宫外孕
      what_to_expect: |
        阴道超声或腹部超声
        抽血检查（血型、血常规、肝肾功能等）
        量血压、体重
      dad_role: |
        全程陪同，一起看第一次B超
        帮忙记录医生说的重要信息
        提前准备好需要问的问题

dad_tip_of_week: |
  "这周你能做的最重要的事：什么都别说，就陪着她。
  准备小零食、帮她避开难闻的气味、让她多休息。
  她可能会情绪低落或焦虑——你不需要解决问题，只需要让她知道你在。"
```

*(第12、24、32、38周示例结构相同，详见完整文档)*

---

**文档版本**: v2.2
**最后更新**: 2025-12-22
**更新记录**:
- v2.2: 知识库医学修正完成（食物安全库新增桂圆/山楂/薏米CAUTION条目；症状决策树胎动标准改为进食后1小时；应急流程CPR添加孕晚期左倾体位说明）
- v2.1: TimelineScreen 40周时间线完成（FlatList虚拟列表+可展开WeekCard+三孕期TrimesterHeader分隔+当前周高亮自动滚动+跨平台兼容）
- v2.0: Phase 5 情感功能完成（里程碑记录+爸爸成长系统+成就墙+工具页XP/成就集成）
- v1.9: Phase 4 工具功能完成（宫缩计时器+胎动计数器+待产包清单+紧急联系人+审计修复）
- v1.8: Phase 3 知识库集成完成（KB数据库+FTS5搜索+意图检测+上下文注入+数据导入管道）
- v1.7: 添加 Web 平台支持（react-native-web + localStorage shim，平台条件加载）
- v1.6: Phase 2 核心交互完成（引导流程、AI Provider、上下文注入、对话界面、首页Dashboard）
- v1.5: Phase 1 基础框架完成（项目初始化、导航、数据库、状态管理、类型系统）
- v1.4: 完成AI审核，标记待专业审核问题项
- v1.3: 周任务库完成（140+条，40周全覆盖）
- v1.2: 知识库全部完成（食物安全库150+条、症状决策树22条、情绪场景剧本30条、应急流程7条）
- v1.1: APP名称确认为「伴生」，40周数据已完成
- v1.0: 初始版本
